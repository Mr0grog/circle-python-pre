version: 2.1

jobs:
  smoke_test:
    parameters:
      image_tag:
        description: 'Python image tag to test'
        type: string
      version:
        description: 'Expected version of Python to be used'
        type: string
    docker:
      - image: "mr0grog/circle-python-pre:<< parameters.image_tag >>"
    steps:
      - run:
          name: Check Python Version
          command: |
            ACTUAL_VERSION="$(python --version)"
            echo "'python --version' == '${ACTUAL_VERSION}'"
            if [ "${ACTUAL_VERSION}" = 'Python << parameters.version >>' ]; then
              true
            else
              echo 'Did not find expected Python version!'
              false
            fi

      - run:
          name: Run a Simple Python Script
          command: |
            OUTPUT="$(python -c 'print("Hello from Python")')"
            echo "${OUTPUT}"
            if [ "${OUTPUT}" = 'Hello from Python' ]; then
              true
            else
              echo 'Did not get expected output!'
              false
            fi

      - run:
          name: Upgrade Pip
          command: |
            pip install --upgrade pip

  build:
    machine:
      image: ubuntu-2004:current
      docker_layer_caching: true
    steps:
      - checkout
      - run:
          name: Build Docker Image
          command: |
            docker run --rm --privileged multiarch/qemu-user-static:register --reset --credential yes
            ./build.sh

workflows:
  ci:
    jobs:
      - smoke_test:
          image_tag: 3.13.0b4
          version: 3.13.0b4
      - smoke_test:
          name: smoke_test-freethreading
          image_tag: 3.13.0b4t
          version: 3.13.0b4
      - build
